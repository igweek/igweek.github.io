> [!note]
> KVM（Kernel-based Virtual Machine）KVM支持两种类型的迁移：
> 1. **冷迁移**（Cold Migration）：在迁移过程中，虚拟机会停止运行，迁移完成后再启动。
> 2. **热迁移**（Live Migration）：虚拟机在迁移过程中保持运行，迁移完成后无缝切换，适用于需要最小化停机时间的场景。

### 迁移前的准备
在进行KVM虚拟机迁移前，需确保以下几点：
- **相同的网络环境**：源主机和目标主机必须能够互相访问。
- **存储共享或NFS共享**：源主机和目标主机需要能够访问同一个虚拟机存储，或者通过NFS共享虚拟机的磁盘映像。
- **相同的CPU架构**：源主机和目标主机的硬件架构要兼容。
- **相同的KVM版本**：最好确保源主机和目标主机运行相同版本的KVM。


#### 热迁移命令
**命令**：
```bash
virsh migrate --live <VM_NAME> qemu+ssh://<TARGET_HOST>/system
```

#### 迁移命令各个参数说明：
- **`migrate`**：表示执行迁移操作。
- **`--live`**：表示进行热迁移（虚拟机在迁移过程中仍然运行）。如果不加`--live`，则会进行冷迁移，虚拟机会在迁移过程中停止。
- **`<VM_NAME>`**：待迁移的虚拟机的名称。可以使用`virsh list`命令查看当前正在运行的虚拟机。
- **`qemu+ssh://<TARGET_HOST>/system`**：目标主机的信息，其中：
  - `qemu+ssh://`：表示通过SSH协议连接到目标主机。
  - `<TARGET_HOST>`：目标主机的IP地址或主机名。例如，`qemu+ssh://192.168.1.100/system`表示目标主机是IP地址为`192.168.1.100`的机器。
  - `/system`：指的是系统级的虚拟机管理。

#### 冷迁移命令
如果想执行冷迁移（即迁移期间虚拟机将停止），可以使用以下命令：
```bash
virsh migrate --persistent <VM_NAME> qemu+ssh://<TARGET_HOST>/system
```
与热迁移相比，冷迁移会在迁移前停止虚拟机的运行，迁移完成后再启动。

### 迁移的具体步骤
1. **检查源主机和目标主机的配置**：
   - 确保目标主机上已经安装并配置好KVM和`libvirt`服务。
   - 确保源主机和目标主机之间的网络连接正常。
   - 确保虚拟机磁盘可以被目标主机访问，可以使用共享存储或通过NFS等方式共享磁盘映像。

2. **停止虚拟机（如果是冷迁移）**：
   如果你执行的是冷迁移，首先需要停止虚拟机。在源主机上使用以下命令：
   ```bash
   virsh shutdown <VM_NAME>
   ```
   等待虚拟机完全关闭，确认虚拟机不再运行：
   ```bash
   virsh list --all
   ```

3. **执行迁移命令**：
   根据你选择的迁移类型（热迁移或冷迁移），在源主机上执行相应的命令：
   - 热迁移：
     ```bash
     virsh migrate --live <VM_NAME> qemu+ssh://<TARGET_HOST>/system
     ```
   - 冷迁移：
     ```bash
     virsh migrate --persistent <VM_NAME> qemu+ssh://<TARGET_HOST>/system
     ```

4. **监控迁移过程**：
   在迁移过程中，可以通过查看`virsh`的状态来监控虚拟机迁移情况：
   ```bash
   virsh list --all
   ```

   如果迁移成功，虚拟机将出现在目标主机上并处于运行状态。

5. **确认虚拟机是否迁移成功**：
   在目标主机上使用以下命令确认虚拟机是否迁移成功：
   ```bash
   virsh list --all
   ```

6. **启动虚拟机（如果是冷迁移）**：
   如果执行的是冷迁移，虚拟机会在迁移完成后自动启动。如果没有自动启动，可以手动启动：
   ```bash
   virsh start <VM_NAME>
   ```

### 热迁移与冷迁移的区别
- **热迁移**：
  - 虚拟机在迁移过程中保持运行，用户几乎不会感知到中断。
  - 适用于需要最小化停机时间的场景。
  - 需要源主机和目标主机有共享存储，或者通过网络存储进行数据迁移。

- **冷迁移**：
  - 虚拟机在迁移过程中会停机，适用于不要求高度可用的环境。
  - 通常用于维护或升级物理服务器时迁移虚拟机。

### 注意事项
- **网络带宽**：迁移虚拟机时需要大量的网络带宽，特别是在进行热迁移时。如果网络带宽不足，迁移过程可能非常缓慢。
- **存储配置**：热迁移时，源主机和目标主机必须能访问相同的存储。如果使用本地存储，可能需要额外配置存储复制或使用共享存储。
- **虚拟机配置**：迁移时，确保源主机和目标主机的虚拟机配置（如CPU、内存等）兼容，否则可能导致迁移失败。

### 总结
KVM虚拟机的迁移命令 `virsh migrate` 提供了简单而强大的功能来实现虚拟机的热迁移和冷迁移。通过 `--live` 参数可以进行热迁移，而通过 `--persistent` 参数可以进行冷迁移。