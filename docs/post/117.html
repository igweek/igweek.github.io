<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="dark" data-light-theme="light" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href='https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Primer/21.0.7/primer.css' rel='stylesheet' />
    <script async src='https://www.googletagmanager.com/gtag/js?id=G-5KH0XJYCQ7'></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-5KH0XJYCQ7');</script><script defer src="https://umami.myla.eu.org/script.js" data-website-id="a7942b92-e528-4d9b-a65a-4c19d4a8b4f1"></script><script src='/plugins/GmeekVercount.js'></script>
    <link rel="icon" href="/img/123.png"><script>
        let theme = localStorage.getItem("meek_theme") || "light";
        document.documentElement.setAttribute("data-color-mode", theme);
    </script>
<meta name="description" content="![image.png](https://pic.myla.eu.org/file/XccFyQC8.png)

## 换源 [​](#换源)

PVE 9.0 基于 Debian 13，除了换 Debian 的软件源以外，还需要编辑企业源、Ceph 源、无订阅源以及 CT 模板源。">
<meta property="og:title" content="PVE的一些基础设置">
<meta property="og:description" content="![image.png](https://pic.myla.eu.org/file/XccFyQC8.png)

## 换源 [​](#换源)

PVE 9.0 基于 Debian 13，除了换 Debian 的软件源以外，还需要编辑企业源、Ceph 源、无订阅源以及 CT 模板源。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://bbs.017121.xyz/post/117.html">
<meta property="og:image" content="/img/123.png">
<title>PVE的一些基础设置</title>
<link href="//unpkg.com/@wooorm/starry-night@2.1.1/style/both.css" rel="stylesheet" />


</head>
<style>
body{box-sizing: border-box;min-width: 200px;max-width: 900px;margin: 20px auto;padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top:64px; text-align: center;font-size: small;}

</style>

<style>
.postTitle{margin: auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 600px) {
    body {padding: 8px;}
    .postTitle{font-size:24px;}
}
.copy-feedback {
    display: none;
    position: absolute;
    top: 10px;
    right: 50px;
    color: var(--color-fg-on-emphasis);
    background-color: var(--color-fg-muted);
    border-radius: 3px;
    padding: 5px 8px;
    font-size: 12px;
}
</style>
<style>html{background-color:#FFFCF8!important;min-height:100vh!important;background-image:linear-gradient(to right,rgba(0,0,0,0.2) 1px,transparent 1px),linear-gradient(to bottom,rgba(0,0,0,0.2) 1px,transparent 1px)!important;background-size:32px 32px!important;background-attachment:fixed!important}html body{min-width:200px!important;max-width:760px!important;margin:0 auto!important;padding:1em!important;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;color:#595959;font-size:16px;line-height:1.8em;background-color:rgba(255,255,255,0.9)!important;word-break:break-all}blockquote{margin-left:0;background-color:#ebf4ff;border-color:#7f9cf5;padding-top:.5rem;padding-bottom:.5rem;color:#667eea}strong{color:#5a67d8}code,a{color:#5a67d8}a{border-color:#667eea}code{background-color:#ebf4ff}blockquote,details,dl,ol,p,pre,table,ul{margin-bottom:1rem}ol{list-style:decimal}ul{list-style:disc}ol,ul{padding-left:2em}h1,h2{border-color:#5a67d8;border-style:solid;border-top-width:0;border-right-width:0;font-weight:500;padding-top:.25rem;padding-bottom:.25rem;padding-left:.75rem}h1{border-bottom:1px solid #eaecef !important;border-left-width:0}h2{border-bottom:1px solid #eaecef !important;border-left-width:6px}h1,h2,h3,h4,h5,h6{margin-bottom:16px;line-height:1.25}blockquote{padding-top:.5rem;padding-bottom:.5rem;padding-left:1rem;padding-right:.5rem;border-left:.25em solid}blockquote>:last-child{margin-bottom:0}blockquote>:first-child{margin-top:0}strong{font-weight:700}strong::before{content:'「'}strong::after{content:'」'}code,a{font-weight:500}code,a{font-size:unset}a{text-decoration:none;border-bottom:1px solid}.footnote-ref{border-width:0}code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}pre>code{font-weight:400;color:unset;line-height:1.6}picture img{border-radius:6px;display:block;margin:10px 0;object-fit:contain;box-shadow:2px 4px 7px #999}img{max-width:100%;display:block;margin:10px 0;object-fit:contain;border-radius:6px;box-shadow:2px 4px 7px #999}picture{display:flex;flex-direction:column;align-items:flex-start;margin-top:6px;margin-bottom:6px}pre,pre code[class*="language-"]{display:block;overflow-x:auto;padding:0}pre code[class*="language-"]{padding:12px;padding-top:6px}.svg-markmap-box{min-height:20rem;width:100%}.footnotes{padding-top:.5rem;padding-bottom:.5rem}code[class*="language-"],pre[class*="language-"]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*="language-"]{padding:1em;margin:.5em 0;overflow:auto;border-radius:6px}:not(pre)>code[class*="language-"],pre[class*="language-"]{background:#272822}:not(pre)>code[class*="language-" ]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment,.token.prolog,.token.doctype,.token.cdata{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.property,.token.tag,.token.constant,.token.symbol,.token.deleted{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.selector,.token.attr-name,.token.string,.token.char,.token.builtin,.token.inserted{color:#a6e22e}.token.operator,.token.entity,.token.url,.language-css .token.string,.style .token.string,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.function,.token.class-name{color:#e6db74}.token.keyword{color:#66d9ef}.token.regex,.token.important{color:#fd971f}.token.important,.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}h3{padding-left:.75rem;border-left:4px solid #5a67d8}</style>



<body>
    <div id="header">
<h1 class="postTitle">PVE的一些基础设置</h1>
<div class="title-right">
    <a href="https://bbs.017121.xyz" id="buttonHome" class="btn btn-invisible circle" title="首页">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    
    <a href="https://github.com/igweek/igweek.github.io/issues/117" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16">
            <path id="pathIssue" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="切换主题">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/fad396823125496d8cf3a7091ba82d673ef6baf1fcecad13a4eaae218553da16/68747470733a2f2f7069632e6d796c612e65752e6f72672f66696c652f58636346795143382e706e67"><img src="https://camo.githubusercontent.com/fad396823125496d8cf3a7091ba82d673ef6baf1fcecad13a4eaae218553da16/68747470733a2f2f7069632e6d796c612e65752e6f72672f66696c652f58636346795143382e706e67" alt="image.png" data-canonical-src="https://pic.myla.eu.org/file/XccFyQC8.png" style="max-width: 100%;"></a></p>
<h2>换源 <a href="#%E6%8D%A2%E6%BA%90">​</a></h2>
<p>PVE 9.0 基于 Debian 13，除了换 Debian 的软件源以外，还需要编辑企业源、Ceph 源、无订阅源以及 CT 模板源。</p>
<h3>Debian 软件源 <a href="#debian-%E8%BD%AF%E4%BB%B6%E6%BA%90">​</a></h3>
<p>提示</p>
<p>Debian 13 软件源变更为 <code class="notranslate">DEB822</code> 格式 <code class="notranslate">/etc/apt/sources.list.d/debian.sources</code> ，不再是传统格式 <code class="notranslate">/etc/apt/sources.list</code></p>
<p>与常规的 Debian 13 一样，将 <code class="notranslate">/etc/apt/sources.list.d/debian.sources</code> 中默认源全部删除，将其替换为清华源</p>
<p>/etc/apt/sources.list.d/debian.sources</p>
<div class="highlight highlight-text-md"><pre class="notranslate">Types: deb
URIs: <span class="pl-corl">https://mirrors.tuna.tsinghua.edu.cn/debian</span>
Suites: trixie trixie-updates trixie-backports
Components: main contrib non-free non-free-firmware
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

<span class="pl-mh"># <span class="pl-en">默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span></span>

<span class="pl-mh"># <span class="pl-en">Types: deb-src</span></span>

<span class="pl-mh"># <span class="pl-en">URIs: <span class="pl-corl">https://mirrors.tuna.tsinghua.edu.cn/debian</span></span></span>

<span class="pl-mh"># <span class="pl-en">Suites: trixie trixie-updates trixie-backports</span></span>

<span class="pl-mh"># <span class="pl-en">Components: main contrib non-free non-free-firmware</span></span>

<span class="pl-mh"># <span class="pl-en">Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg</span></span>

<span class="pl-mh"># <span class="pl-en">以下安全更新软件源包含了官方源与镜像站配置，如有需要可自行修改注释切换</span></span>

Types: deb
URIs: <span class="pl-corl">https://security.debian.org/debian-security</span>
Suites: trixie-security
Components: main contrib non-free non-free-firmware
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

<span class="pl-mh"># <span class="pl-en">Types: deb-src</span></span>

<span class="pl-mh"># <span class="pl-en">URIs: <span class="pl-corl">https://security.debian.org/debian-security</span></span></span>

<span class="pl-mh"># <span class="pl-en">Suites: trixie-security</span></span>

<span class="pl-mh"># <span class="pl-en">Components: main contrib non-free non-free-firmware</span></span>

<span class="pl-mh"># <span class="pl-en">Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg</span></span></pre></div>
<h3>企业源 <a href="#%E4%BC%81%E4%B8%9A%E6%BA%90">​</a></h3>
<p>将 PVE 的企业源 <code class="notranslate">/etc/apt/sources.list.d/pve-enterprise.sources</code> 注释掉（也可以直接删除）</p>
<p>/etc/apt/sources.list.d/pve-enterprise.sources</p>
<div class="highlight highlight-text-md"><pre class="notranslate"><span class="pl-mh"># <span class="pl-en">Types: deb</span></span>

<span class="pl-mh"># <span class="pl-en">URIs: <span class="pl-corl">https://enterprise.proxmox.com/debian/pve</span></span></span>

<span class="pl-mh"># <span class="pl-en">Suites: trixie</span></span>

<span class="pl-mh"># <span class="pl-en">Components: pve-enterprise</span></span>

<span class="pl-mh"># <span class="pl-en">Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg</span></span></pre></div>
<h3>Ceph 源 <a href="#ceph-%E6%BA%90">​</a></h3>
<p>将 PVE 的 Ceph 源 <code class="notranslate">/etc/apt/sources.list.d/ceph.sources</code> 也替换成清华源</p>
<p>/etc/apt/sources.list.d/ceph.sources</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">Types: deb
URIs: https://mirrors.tuna.tsinghua.edu.cn/proxmox/debian/ceph-squid
Suites: trixie
Components: no-subscription
Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg</pre></div>
<h3>无订阅源 <a href="#%E6%97%A0%E8%AE%A2%E9%98%85%E6%BA%90">​</a></h3>
<p>在 <code class="notranslate">/etc/apt/sources.list.d</code> 目录下创建 <code class="notranslate">pve-no-subscription.sources</code> 文件，填上以下内容</p>
<p>/etc/apt/sources.list.d/pve-no-subscription.sources</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">Types: deb
URIs: https://mirrors.tuna.tsinghua.edu.cn/proxmox/debian/pve
Suites: trixie
Components: pve-no-subscription
Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg</pre></div>
<h3>CT 模板源 <a href="#ct-%E6%A8%A1%E6%9D%BF%E6%BA%90">​</a></h3>
<p>如果你需要用到 PVE 中的 LXC 容器，那么还需要替换一下 CT 模板源，否则下载模板会非常的慢</p>
<p>将 <code class="notranslate">/usr/share/perl5/PVE/APLInfo.pm</code> 文件中默认的源地址 <code class="notranslate">http://download.proxmox.com</code> 替换为</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">https://mirrors.tuna.tsinghua.edu.cn/proxmox</pre></div>
<p>可以使用如下命令修改，重启后生效</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">cp /usr/share/perl5/PVE/APLInfo.pm /usr/share/perl5/PVE/APLInfo.pm_back
sed -i <span class="pl-s"><span class="pl-pds">'</span>s|http://download.proxmox.com|https://mirrors.tuna.tsinghua.edu.cn/proxmox|g<span class="pl-pds">'</span></span> /usr/share/perl5/PVE/APLInfo.pm</pre></div>
<h3>删除订阅弹窗 <a href="#%E5%88%A0%E9%99%A4%E8%AE%A2%E9%98%85%E5%BC%B9%E7%AA%97">​</a></h3>
<p>尽管我们使用的 PVE 是免费版，但如果你没有订阅，每次访问网页时，都会有一个“无有效订阅”的弹窗</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/861d3b08e7077efb2e512a40361ddc8cd228e2a15c4f840301319e57d7ff1f1e/68747470733a2f2f73332e7a68696368616f2e6f72672f696d616765732f7076652d696e7374616c6c6174696f6e2d737562736372697074696f6e2d706f702d75702e77656270"><img src="https://camo.githubusercontent.com/861d3b08e7077efb2e512a40361ddc8cd228e2a15c4f840301319e57d7ff1f1e/68747470733a2f2f73332e7a68696368616f2e6f72672f696d616765732f7076652d696e7374616c6c6174696f6e2d737562736372697074696f6e2d706f702d75702e77656270" alt="订阅弹窗" data-canonical-src="https://s3.zhichao.org/images/pve-installation-subscription-pop-up.webp" style="max-width: 100%;"></a></p>
<p>订阅弹窗</p>
<p>弹窗代码在 <code class="notranslate">/usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js</code> 中，通过 <code class="notranslate">void({...})</code> 可以让弹窗部分代码不执行，实现删除弹窗的效果。</p>
<p>因此，直接执行以下命令即可实现删除订阅弹窗</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">sed -Ezi.bak <span class="pl-s"><span class="pl-pds">"</span>s/(Ext.Msg.show\(\{\s+title: gettext\('No valid sub)/void\(\{ \/\/\1/g<span class="pl-pds">"</span></span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js <span class="pl-k">&amp;&amp;</span> systemctl restart pveproxy.service</pre></div>
<h2>硬盘 <a href="#%E7%A1%AC%E7%9B%98">​</a></h2>
<h3>合并 local 与 local-lvm <a href="#%E5%90%88%E5%B9%B6-local-%E4%B8%8E-local-lvm">​</a></h3>
<p>提示</p>
<ol>
<li>只建议<strong>系统盘比较小的</strong>这么操作，<strong>系统盘大的</strong>的建议保持默认！</li>
<li>由于我的傲腾系统盘太小，PVE 安装程序跳过了创建 <code class="notranslate">local-lvm</code>，因此以下内容未进行实操验证，<strong>仅供参考</strong></li>
</ol>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/6a4f2c3af80e8d3da5b954d0f618dc59ba1479225a20a6e6282f7b0107bb3919/68747470733a2f2f73332e7a68696368616f2e6f72672f696d616765732f7076652d696e7374616c6c6174696f6e2d6c6f63616c2d6c766d2e77656270"><img src="https://camo.githubusercontent.com/6a4f2c3af80e8d3da5b954d0f618dc59ba1479225a20a6e6282f7b0107bb3919/68747470733a2f2f73332e7a68696368616f2e6f72672f696d616765732f7076652d696e7374616c6c6174696f6e2d6c6f63616c2d6c766d2e77656270" alt="跳过创建 local-lvm" data-canonical-src="https://s3.zhichao.org/images/pve-installation-local-lvm.webp" style="max-width: 100%;"></a></p>
<p>跳过创建 local-lvm</p>
<p>PVE 安装过程中会自动创建 <code class="notranslate">local</code> 和 <code class="notranslate">local-lvm</code>，如果你的系统盘不够大，可能会出现一个用满了，另一个却比较空的情况，提前将两者合并就可以避免出现这种尴尬的情况。</p>
<ol>
<li>删除 <code class="notranslate">local-lvm</code> 分区</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">lvremove /dev/pve/data</pre></div>
<ol start="2">
<li>扩容 local</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">lvextend -l +100%FREE /dev/pve/root</pre></div>
<ol start="3">
<li>扩展文件系统</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">resize2fs /dev/pve/root</pre></div>
<ol start="4">
<li>在 Web UI 上删除 local-lvm，然后编辑 local 勾选所有内容</li>
</ol>
<h3>删除 Swap 分配给主分区 <a href="#%E5%88%A0%E9%99%A4-swap-%E5%88%86%E9%85%8D%E7%BB%99%E4%B8%BB%E5%88%86%E5%8C%BA">​</a></h3>
<p>提示</p>
<p>只建议<strong>系统盘特别小的</strong>这么操作，<strong>系统盘大的</strong>的建议保持默认！</p>
<p>PVE 安装后默认会根据硬盘大小分配 Swap，但我的系统盘是 16G 的傲腾，本身就已经寸土寸金了，再加上 G4560 配上 16G 内存也基本够用了。如果把默认分配的 1G Swap 删除，重新分配给系统分区的话，更加宽裕一些。</p>
<ol>
<li>关闭 Swap</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">swapoff /dev/mapper/pve-swap</pre></div>
<ol start="2">
<li>编辑 <code class="notranslate">/etc/fstab</code>，注释掉 Swap 挂载行</li>
</ol>
<div class="highlight highlight-text-md"><pre class="notranslate"><span class="pl-mh"># <span class="pl-en">/dev/pve/swap none swap sw 0 0</span></span></pre></div>
<ol start="3">
<li>删除 swap 的 LVM 卷</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">lvremove /dev/pve/swap</pre></div>
<ol start="4">
<li>扩展 <code class="notranslate">pve-root</code> 卷到全部剩余空间</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">lvextend -l +100%FREE /dev/mapper/pve-root</pre></div>
<ol start="5">
<li>扩展文件系统</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">resize2fs /dev/mapper/pve-root</pre></div>
<h3>添加硬盘 <a href="#%E6%B7%BB%E5%8A%A0%E7%A1%AC%E7%9B%98">​</a></h3>
<p>如果想给 PVE 添加硬盘，首先需要将硬盘挂载到 PVE 上，然后再在 Web UI 中添加<strong>存储</strong>。其中挂载到 PVE 的步骤与常规 Debian 挂载硬盘相同，不了解的可以参考<a href="https://zhichao.org/posts/a1207e" rel="nofollow">《Linux 挂载磁盘的两种方式》</a></p>
<p>完成挂载后，来到 <code class="notranslate">数据中心 -&gt; 存储 -&gt; 添加 -&gt; 目录</code> 填写上 ID 和挂载的目录，内容勾选所有选项，最后点击添加即可</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/0c5f4b59bfdd11949cad17a4ec97880e521e678db0a82c047e96f7f87e2b64f8/68747470733a2f2f73332e7a68696368616f2e6f72672f696d616765732f7076652d696e7374616c6c6174696f6e2d6164642d64726976652e77656270"><img src="https://camo.githubusercontent.com/0c5f4b59bfdd11949cad17a4ec97880e521e678db0a82c047e96f7f87e2b64f8/68747470733a2f2f73332e7a68696368616f2e6f72672f696d616765732f7076652d696e7374616c6c6174696f6e2d6164642d64726976652e77656270" alt="添加硬盘" data-canonical-src="https://s3.zhichao.org/images/pve-installation-add-drive.webp" style="max-width: 100%;"></a></p>
<p>添加硬盘</p>
<h2>网络 <a href="#%E7%BD%91%E7%BB%9C">​</a></h2>
<h3>DHCP <a href="#dhcp">​</a></h3>
<p>如果你的网络环境经常变动，则可以将静态 IP 修改为 DHCP，通过 DHCP 分配 IP，方便网络变动后连接 PVE 设备</p>
<p>安装 <code class="notranslate">isc-dhcp-client</code></p>
<div class="highlight highlight-source-shell"><pre class="notranslate">apt install isc-dhcp-client</pre></div>
<p>编辑 <code class="notranslate">/etc/network/interfaces</code>，将 <code class="notranslate">static</code> 修改为 <code class="notranslate">dhcp</code>，然后将地址和网关删除</p>
<p>/etc/network/interfaces</p>
<div class="highlight highlight-source-diff"><pre class="notranslate">auto lo
iface lo inet loopback

iface enp4s0 inet manual

auto vmbr0
iface vmbr0 inet dhcp
iface vmbr0 inet static
        address 10.0.0.10/24
        gateway 10.0.0.1
        bridge-ports enp4s0
        bridge-stp off
        bridge-fd 0

source /etc/network/interfaces.d/*</pre></div>
<h3>SLAAC <a href="#slaac">​</a></h3>
<p>之前一直想给 PVE 添加 IPv6 地址，但通过下面这行代码获取的 IPv6 会同时启用 SLAAC 和 DHCPv6，总会遇到一些奇奇怪怪的<strong>问题</strong>。</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">iface vmbr0 inet6 auto</pre></div>
<p>后面发现可以直接在 <code class="notranslate">/etc/network/interfaces</code> 中添加下面这行代码，来启用 SLAAC 获取 IPv6 地址，目前使用下来还没遇到过问题。</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">post-up <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>2<span class="pl-pds">"</span></span> <span class="pl-k">&gt;</span> /proc/sys/net/ipv6/conf/vmbr0/accept_ra</pre></div>
<p>完整配置如下：</p>
<p>/etc/network/interfaces</p>
<div class="highlight highlight-source-diff"><pre class="notranslate">auto lo
iface lo inet loopback

iface enp3s0 inet manual

auto vmbr0
iface vmbr0 inet dhcp
        bridge-ports enp3s0
        bridge-stp off
        bridge-fd 0
        post-up echo "2" &gt; /proc/sys/net/ipv6/conf/vmbr0/accept_ra

source /etc/network/interfaces.d/*</pre></div>
<p>接着重启一下网络，过一小会应该就能获取到 IPv6 了</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">systemctl restart networking</pre></div>
<h3>网卡灯不亮（无网络） <a href="#%E7%BD%91%E5%8D%A1%E7%81%AF%E4%B8%8D%E4%BA%AE-%E6%97%A0%E7%BD%91%E7%BB%9C">​</a></h3>
<p>常见于移除/更换了 PCI-E 设备，比如显卡、 M.2 硬盘，我是在装完系统后<strong>拔下显卡</strong>后出现的问题，主要原因是拔下显卡后，网卡的编号发生了改变，而 PVE 的网络配置却不会跟着改变。</p>
<p>查看 <code class="notranslate">/etc/network/interfaces</code> 可以看到，网卡为 <code class="notranslate">enp4s0</code>，而通过 <code class="notranslate">ip a</code> 查看，此时的网卡已经变为了 <code class="notranslate">enp3s0</code>，只需要将两处 <code class="notranslate">enp4s0</code> 修改为 <code class="notranslate">enp3s0</code></p>
<p>/etc/network/interfaces</p>
<div class="highlight highlight-source-diff"><pre class="notranslate">auto lo
iface lo inet loopback

iface enp4s0 inet manual
iface enp3s0 inet manual

auto vmbr0
iface vmbr0 inet dhcp
        bridge-ports enp4s0
        bridge-ports enp3s0
        bridge-stp off
        bridge-fd 0

source /etc/network/interfaces.d/*</pre></div>
<p>然后重启一下网络，就可以恢复了</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">systemctl restart networking</pre></div>
<p>如果你经常新增/减少 PCI-E 设备，可以考虑将网卡命名修改回传统名称，详见下方<a href="#%E4%BF%AE%E6%94%B9%E7%BD%91%E5%8D%A1%E5%90%8D">修改网卡名</a></p>
<h3>修改网卡名 <a href="#%E4%BF%AE%E6%94%B9%E7%BD%91%E5%8D%A1%E5%90%8D">​</a></h3>
<p>要想将网卡修改回 <code class="notranslate">eth0</code> 这样的传统名称，只需要编辑启动参数，在 <code class="notranslate">/etc/default/grub</code> 配置中加上 <code class="notranslate">net.ifnames=0 biosdevname=0</code></p>
<p>/etc/default/grub</p>
<div class="highlight highlight-source-diff"><pre class="notranslate"><span class="pl-c"><span class="pl-c">#</span> If you change this file, run 'update-grub' afterwards to update</span>
<span class="pl-c"><span class="pl-c">#</span> /boot/grub/grub.cfg.</span>
<span class="pl-c"><span class="pl-c">#</span> For full documentation of the options in this file, see:</span>
<span class="pl-c"><span class="pl-c">#</span>   info -f grub -n 'Simple configuration'</span>

GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || echo Debian`
GRUB_CMDLINE_LINUX_DEFAULT="quiet"
GRUB_CMDLINE_LINUX_DEFAULT="quiet net.ifnames=0 biosdevname=0"
GRUB_CMDLINE_LINUX=""</pre></div>
<p>然后更新 grub 后重启，网卡名就会变成传统的 <code class="notranslate">eth0</code>、<code class="notranslate">eth1</code></p>
<div class="highlight highlight-source-shell"><pre class="notranslate">update-grub</pre></div>
<p><strong>重启前</strong>，别忘了把 <code class="notranslate">/etc/network/interfaces</code> 中的网卡名也修改成 <code class="notranslate">eth0</code>，否则会断网</p>
<p>/etc/network/interfaces</p>
<div class="highlight highlight-source-diff"><pre class="notranslate">auto lo
iface lo inet loopback

iface enp4s0 inet manual
iface eth0 inet manual

auto vmbr0
iface vmbr0 inet dhcp
        bridge-ports enp4s0
        bridge-ports eth0
        bridge-stp off
        bridge-fd 0

source /etc/network/interfaces.d/*</pre></div>
<h2>网络唤醒 WOL <a href="#%E7%BD%91%E7%BB%9C%E5%94%A4%E9%86%92-wol">​</a></h2>
<p>提示</p>
<p>需要在 BIOS 中开启 PCI-E 唤醒</p>
<p>默认情况下，PVE 的网络唤醒是禁用的，需要手动打开才可以网络唤醒。</p>
<h3>开启 WOL <a href="#%E5%BC%80%E5%90%AF-wol">​</a></h3>
<ol>
<li>安装 ethtool 工具</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">apt install ethtool</pre></div>
<ol start="2">
<li>查看网卡名称 <code class="notranslate">ip a</code></li>
<li>查看网卡信息</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">ethtool eth0</pre></div>
<ol start="4">
<li>观察 <code class="notranslate">Supports Wake-on</code> 与 <code class="notranslate">Wake-on</code></li>
</ol>
<p>提示</p>
<p><code class="notranslate">supports wake-on</code> 判断该网卡是否支持 WOL 唤醒，若值为 pumbg 则表示支持 WOL</p>
<p><code class="notranslate">Wake-on</code> 值为 d 则表示 WOL 禁用状态，g 则为开启，PVE 默认为 d</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">Settings <span class="pl-k">for</span> eth0:
        Supported ports: [ TP    MII ]
        Supported link modes:   10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Supported pause frame use: Symmetric Receive-only
        Supports auto-negotiation: Yes
        Supported FEC modes: Not reported
        Advertised link modes:  10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Advertised pause frame use: Symmetric Receive-only
        Advertised auto-negotiation: Yes
        Advertised FEC modes: Not reported
        Link partner advertised link modes:  10baseT/Half 10baseT/Full
                                             100baseT/Half 100baseT/Full
                                             1000baseT/Half 1000baseT/Full
        Link partner advertised pause frame use: Symmetric Receive-only
        Link partner advertised auto-negotiation: Yes
        Link partner advertised FEC modes: Not reported
        Speed: 1000Mb/s
        Duplex: Full
        Auto-negotiation: on
        master-slave cfg: preferred slave
        master-slave status: slave
        Port: Twisted Pair
        PHYAD: 0
        Transceiver: external
        MDI-X: Unknown
        Supports Wake-on: pumbg
        Wake-on: d
        Current message level: 0x0000003f (63)
                               drv probe link timer ifdown ifup
        Link detected: yes</pre></div>
<ol start="5">
<li>开启 WOL 网络唤醒</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">ethtool -s eth0 wol g</pre></div>
<h3>开机运行 <a href="#%E5%BC%80%E6%9C%BA%E8%BF%90%E8%A1%8C">​</a></h3>
<p>由于每次开机时，<code class="notranslate">Wake-on</code> 的值都会重置为 d，因此需要在开机时自动运行开启 WOL 的命令</p>
<ol>
<li>编辑 <code class="notranslate">/etc/rc.local</code> 文件</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate"><span class="pl-c"><span class="pl-c">#!</span>/bin/bash</span>
ethtool -s eth0 wol g

<span class="pl-c1">exit</span> 0</pre></div>
<ol start="2">
<li>赋予运行权限</li>
</ol>
<div class="highlight highlight-source-shell"><pre class="notranslate">chmod +x /etc/rc.local</pre></div>
<ol start="3">
<li>重启并按上一步骤查看 <code class="notranslate">Wake-on</code> 是否自动在开机时自动修改为 g 即可</li>
</ol></div>
<div style="font-size:small;margin-top:8px;float:right;"></div>

<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">评论</button>
<div class="comments" id="comments"></div>

</div>
    <div id="footer"><div id="footer1">Copyright © <span id="copyrightYear"></span> <a href="https://bbs.017121.xyz">Gweek</a></div>
<div id="footer2">
    <span id="runday"></span><span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a></span>
</div>

<script>
var now=new Date();
document.getElementById("copyrightYear").innerHTML=now.getFullYear();

if(""!=""){
    var startSite=new Date("");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("runday").innerHTML="网站运行"+diffDay+"天"+" • ";
}
</script></div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z', 'copy': 'M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z', 'check': 'M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z'};
var utterancesLoad=0;

let themeSettings={
    "dark": ["dark","moon","#00f0ff","dark-blue"],
    "light": ["light","sun","#ff5000","github-light"],
    "auto": ["auto","sync","","preferred-color-scheme"]
};
function changeTheme(mode, icon, color, utheme){
    document.documentElement.setAttribute("data-color-mode",mode);
    document.getElementById("themeSwitch").setAttribute("d",value=IconList[icon]);
    document.getElementById("themeSwitch").parentNode.style.color=color;
    if(utterancesLoad==1){utterancesTheme(utheme);}
}
function modeSwitch(){
    let currentMode=document.documentElement.getAttribute('data-color-mode');
    let newMode = currentMode === "light" ? "dark" : currentMode === "dark" ? "auto" : "light";
    localStorage.setItem("meek_theme", newMode);
    if(themeSettings[newMode]){
        changeTheme(...themeSettings[newMode]);
    }
}
function utterancesTheme(theme){
    const message={type:'set-theme',theme: theme};
    const iframe=document.getElementsByClassName('utterances-frame')[0];
    iframe.contentWindow.postMessage(message,'https://utteranc.es');
}
if(themeSettings[theme]){changeTheme(...themeSettings[theme]);}
console.log("\n %c Gmeek last https://github.com/Meekdai/Gmeek \n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);



function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","igweek/igweek.github.io");
    script.setAttribute("issue-term","title");
    
    if(localStorage.getItem("meek_theme")=="dark"){script.setAttribute("theme","dark-blue");}
    else if(localStorage.getItem("meek_theme")=="light") {script.setAttribute("theme","github-light");}
    else{script.setAttribute("theme","preferred-color-scheme");}
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const createClipboardHTML = (codeContent, additionalClasses = '') => `
        <pre class="notranslate"><code class="notranslate">${codeContent}</code></pre>
        <div class="clipboard-container position-absolute right-0 top-0 ${additionalClasses}">
            <clipboard-copy class="ClipboardButton btn m-2 p-0" role="button" style="display: inherit;">
                <svg height="16" width="16" class="octicon octicon-copy m-2"><path d="${IconList["copy"]}"></path></svg>
                <svg height="16" width="16" class="octicon octicon-check color-fg-success m-2 d-none"><path d="${IconList["check"]}"></path></svg>
            </clipboard-copy>
            <div class="copy-feedback">Copied!</div>
        </div>
    `;

    const handleCodeElements = (selector = '') => {
        document.querySelectorAll(selector).forEach(codeElement => {
            const codeContent = codeElement.innerHTML;
            const newStructure = document.createElement('div');
            newStructure.className = 'snippet-clipboard-content position-relative overflow-auto';
            newStructure.innerHTML = createClipboardHTML(codeContent);

            const parentElement = codeElement.parentElement;
            if (selector.includes('highlight')) {
                parentElement.insertBefore(newStructure, codeElement.nextSibling);
                parentElement.removeChild(codeElement);
            } else {
                parentElement.parentElement.replaceChild(newStructure, parentElement);
            }
        });
    };

    handleCodeElements('pre.notranslate > code.notranslate');
    handleCodeElements('div.highlight > pre.notranslate');

    let currentFeedback = null;
    document.querySelectorAll('clipboard-copy').forEach(copyButton => {
        copyButton.addEventListener('click', () => {
            const codeContent = copyButton.closest('.snippet-clipboard-content').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const copyIcon = copyButton.querySelector('.octicon-copy');
            const checkIcon = copyButton.querySelector('.octicon-check');
            const copyFeedback = copyButton.nextElementSibling;

            if (currentFeedback && currentFeedback !== copyFeedback) {currentFeedback.style.display = 'none';}
            currentFeedback = copyFeedback;

            copyIcon.classList.add('d-none');
            checkIcon.classList.remove('d-none');
            copyFeedback.style.display = 'block';
            copyButton.style.borderColor = 'var(--color-success-fg)';

            setTimeout(() => {
                copyIcon.classList.remove('d-none');
                checkIcon.classList.add('d-none');
                copyFeedback.style.display = 'none';
                copyButton.style.borderColor = '';
            }, 2000);
        });
    });
});

</script>
<script src='/plugins/articletoc.js'></script><script src='/plugins/lightbox.js'></script>

</html>
